name: Frontend CI + Infra CD Trigger

on:
  push:
    branches: [main, dev, develop, feature/**, bugfix/**, hotfix/**]
  pull_request:
    branches: [main, dev, develop]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  statuses: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  INFRA_REPO: DREAMSCAPE-AI/dreamscape-infra

jobs:
  local-ci:
    name: Local CI & Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft != true
    outputs:
      changed_components: ${{ steps.changes.outputs.changed_components }}
      should_trigger: ${{ steps.check.outputs.should_trigger }}
      skip_reason: ${{ steps.check.outputs.skip_reason }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Detect changed components
        id: changes
        run: |
          CHANGED_COMPONENTS=""

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
          else
            if [[ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]]; then
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.event.after }})
            else
              CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null || git ls-files)
            fi
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          for component in web-client gateway panorama admin-panel mobile-app; do
            if echo "$CHANGED_FILES" | grep -qE "^${component}/"; then
              if [[ -z "$CHANGED_COMPONENTS" ]]; then
                CHANGED_COMPONENTS="$component"
              else
                CHANGED_COMPONENTS="$CHANGED_COMPONENTS,$component"
              fi
            fi
          done

          if echo "$CHANGED_FILES" | grep -qE "^(shared/|common/|packages/)"; then
            CHANGED_COMPONENTS="all"
          fi

          if [[ -z "$CHANGED_COMPONENTS" ]] && [[ -n "$CHANGED_FILES" ]]; then
            CHANGED_COMPONENTS="all"
          fi

          echo "changed_components=${CHANGED_COMPONENTS}" >> $GITHUB_OUTPUT
          echo "Detected changes: ${CHANGED_COMPONENTS}"

      - name: Check if central pipeline should be triggered
        id: check
        run: |
          if [[ -z "${{ steps.changes.outputs.changed_components }}" ]]; then
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            echo "skip_reason=no_changes" >> $GITHUB_OUTPUT
            echo "No changes detected, skipping dispatch"
          elif [[ "${{ github.event_name }}" != "push" ]] || [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            echo "skip_reason=not_main_push" >> $GITHUB_OUTPUT
            echo "Dispatch is enabled only for push on main"
          elif [[ -z "${{ secrets.DISPATCH_TOKEN }}" ]]; then
            echo "should_trigger=false" >> $GITHUB_OUTPUT
            echo "skip_reason=missing_token" >> $GITHUB_OUTPUT
            echo "DISPATCH_TOKEN not configured"
          else
            echo "should_trigger=true" >> $GITHUB_OUTPUT
            echo "skip_reason=none" >> $GITHUB_OUTPUT
            echo "Will trigger infra CD pipeline (staging)"
          fi

      - name: Lint and typecheck changed components
        if: steps.changes.outputs.changed_components != ''
        run: |
          COMPONENTS="${{ steps.changes.outputs.changed_components }}"

          if [[ "${COMPONENTS}" == "all" ]]; then
            COMPONENTS="web-client,gateway,panorama"
          fi

          IFS=',' read -ra COMPONENT_ARRAY <<< "$COMPONENTS"
          for component in "${COMPONENT_ARRAY[@]}"; do
            if [[ -d "${component}" ]] && [[ -f "${component}/package.json" ]]; then
              echo "Validating ${component}..."
              (
                cd "${component}"
                npm ci
                npm run lint --if-present || echo "Lint issues in ${component}"
                npm run typecheck --if-present || echo "Typecheck issues in ${component}"
              )
            fi
          done

  trigger-central-pipeline:
    name: Trigger Infra CD (staging)
    runs-on: ubuntu-latest
    needs: local-ci
    if: needs.local-ci.outputs.should_trigger == 'true'
    steps:
      - name: Trigger Big Pods CD workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.DISPATCH_TOKEN }}
          script: |
            const version = context.sha.substring(0, 12);

            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: 'DREAMSCAPE-AI',
                repo: 'dreamscape-infra',
                workflow_id: 'bigpods-cd.yml',
                ref: 'main',
                inputs: {
                  environment: 'staging',
                  version: version,
                  deployment_strategy: 'rolling',
                  force_deployment: 'false'
                }
              });

              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: 'success',
                target_url: 'https://github.com/DREAMSCAPE-AI/dreamscape-infra/actions',
                description: `Big Pods CD workflow dispatched (staging, version ${version})`,
                context: 'ci/unified-pipeline'
              });
            } catch (error) {
              await github.rest.repos.createCommitStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                sha: context.sha,
                state: 'error',
                description: 'Failed to trigger Big Pods CD workflow',
                context: 'ci/unified-pipeline'
              });

              throw error;
            }

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [local-ci, trigger-central-pipeline]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "# Frontend CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- Event: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Ref: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Changed components: ${{ needs.local-ci.outputs.changed_components }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dispatch decision: ${{ needs.local-ci.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.trigger-central-pipeline.result }}" == "success" ]]; then
            echo "- Big Pods CD trigger: success" >> $GITHUB_STEP_SUMMARY
            echo "- Pipeline URL: https://github.com/DREAMSCAPE-AI/dreamscape-infra/actions/workflows/bigpods-cd.yml" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.trigger-central-pipeline.result }}" == "skipped" ]]; then
            echo "- Big Pods CD trigger: skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Big Pods CD trigger: failed" >> $GITHUB_STEP_SUMMARY
          fi
